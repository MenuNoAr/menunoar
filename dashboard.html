<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Menu no Ar</title>
    <link rel="icon" type="image/svg+xml" href="assets/images/logo.svg">

    <!-- Preconnect to Font Provider -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Plus+Jakarta+Sans:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        media="print" onload="this.media='all'">

    <!-- Menu Styles (Visuals for preview) -->
    <link rel="stylesheet" href="css/menu.css">
    <!-- Editor Styles (Overlays) -->
    <link rel="stylesheet" href="css/editor.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js" defer></script>

    <script>
        // CRITICAL: Check theme BEFORE body renders to avoid white flash
        (function () {
            const savedTheme = localStorage.getItem('menu_theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark-mode');
                // Also add it to body as soon as it exists
                window.addEventListener('scroll', function initTheme() {
                    document.body.classList.add('dark-mode');
                    window.removeEventListener('scroll', initTheme);
                });
            }
        })();
    </script>
</head>

<body>

    <!-- SETUP SCREEN (Visible only if no restaurant) -->
    <div id="setup-screen" class="setup-container" style="display:none;">
        <div class="setup-card">
            <div class="setup-header">
                <img src="assets/images/logo.svg" alt="Logo" class="setup-logo">
                <h2>Bem-vindo</h2>
                <p>Vamos configurar o teu restaurante.</p>
            </div>

            <form id="setupForm" class="setup-form">
                <div class="form-group">
                    <label>Nome do Restaurante</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-store"></i>
                        <input type="text" id="setupName" placeholder="ex: O Tasco do Z√©" required
                            oninput="generateSlug(this.value)">
                    </div>
                </div>

                <div class="form-group">
                    <label>Link Personalizado</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-link"></i>
                        <input type="text" id="setupSlug" placeholder="ex: o-tasco-do-ze" required>
                    </div>
                    <small>menunoar.com/menu.html?id=<b>slug</b></small>
                </div>

                <div class="form-group">
                    <label>Descri√ß√£o Curta</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-align-left"></i>
                        <textarea id="setupDesc" rows="2" placeholder="Descreve o teu espa√ßo..."></textarea>
                    </div>
                </div>

                <div class="form-checkbox-group">
                    <input type="checkbox" id="setupDemo" checked style="width: auto; margin-right: 10px;">
                    <label for="setupDemo">
                        <strong>Adicionar pratos de exemplo?</strong>
                        <span>Cria categorias e pratos iniciais.</span>
                    </label>
                </div>

                <button type="submit" class="btn-confirm btn-full">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Criar Menu
                </button>
            </form>
        </div>
    </div>

    <!-- TRIAL ACTIVATED MODAL (Celebration) -->
    <div id="trialSuccessModal" class="edit-modal">
        <div class="edit-modal-content celebration-card text-center">
            <div class="celebration-icon">
                <i class="fa-solid fa-gift"></i>
            </div>
            <h2 style="margin-top: 15px;">Teste Gr√°tis Ativado! üéâ</h2>
            <p class="celebration-subtitle">Tens 30 dias para explorar todas as ferramentas PRO sem limites.</p>

            <div class="feature-list" style="text-align: left; margin: 25px 0;">
                <div class="feature-item" style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <i class="fa-solid fa-check" style="color: var(--success); margin-top: 5px;"></i>
                    <div>
                        <strong style="display: block;">Menu Ilimitado</strong>
                        <span style="font-size: 0.85rem; opacity: 0.7;">Cria quantos pratos e categorias
                            quiseres.</span>
                    </div>
                </div>
                <div class="feature-item" style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <i class="fa-solid fa-check" style="color: var(--success); margin-top: 5px;"></i>
                    <div>
                        <strong style="display: block;">QR Code Inteligente</strong>
                        <span style="font-size: 0.85rem; opacity: 0.7;">Gera e descarrega o teu QR Code
                            personalizado.</span>
                    </div>
                </div>
                <div class="feature-item" style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <i class="fa-solid fa-check" style="color: var(--success); margin-top: 5px;"></i>
                    <div>
                        <strong style="display: block;">Design Premium</strong>
                        <span style="font-size: 0.85rem; opacity: 0.7;">Personaliza cores, fontes e banners do teu
                            menu.</span>
                    </div>
                </div>
            </div>

            <div class="payment-info-box"
                style="background: var(--bg-page); padding: 15px; border-radius: 12px; margin-bottom: 25px; display: flex; gap: 15px; align-items: start; text-align: left; font-size: 0.85rem;">
                <i class="fa-solid fa-circle-info" style="color: var(--primary); margin-top: 3px;"></i>
                <p style="margin: 0; line-height: 1.4;">Podes confirmar a tua assinatura definitiva a qualquer momento
                    no fundo da p√°gina para garantir que o teu menu nunca fica offline.</p>
            </div>

            <div class="modal-actions" style="justify-content: center; width: 100%; margin: 0;">
                <button class="btn-confirm" onclick="closeModal('trialSuccessModal')"
                    style="width: 100%; justify-content: center;">
                    Come√ßar a Editar <i class="fa-solid fa-chevron-right" style="margin-left: 10px;"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- EXPIRED ACCOUNT BLOCKER -->
    <div id="expiredBlocker" class="locked-overlay" style="display:none;">
        <div class="locked-content">
            <div class="locked-icon">
                <i class="fa-solid fa-lock"></i>
            </div>
            <h2>Acesso Bloqueado</h2>
            <p>O teu per√≠odo de teste gratuito terminou. Para continuares a gerir o teu menu e mant√™-lo online para os
                clientes, ativa o teu plano profissional agora.</p>

            <div class="locked-features">
                <span><i class="fa-solid fa-circle-xmark"></i> Edi√ß√£o de Itens</span>
                <span><i class="fa-solid fa-circle-xmark"></i> Download de QR Code</span>
                <span><i class="fa-solid fa-circle-xmark"></i> Personaliza√ß√£o Visual</span>
            </div>

            <a href="subscription.html" class="btn-confirm btn-full"
                style="text-decoration: none; display: flex; align-items: center; justify-content: center; width: 100%;">
                <i class="fa-solid fa-rocket" style="margin-right: 10px;"></i> Ativar Premium Agora
            </a>
            <button onclick="signOut()" class="btn-nav"
                style="margin-top: 15px; width: 100%; justify-content: center; border: 1px solid var(--border);">
                Sair da Conta
            </button>
        </div>
    </div>

    <!-- MAIN DASHBOARD (Hidden by default until loaded) -->
    <div id="main-dashboard" style="display:none;">

        <div class="dashboard-navbar">
            <div class="nav-brand">
                <img src="assets/images/logo.svg" alt="MenuNoAr" id="dashboardLogo">
                <span class="divider">|</span>
                <span id="userDisplay">Chef</span>
                <span id="trialTimer" class="trial-timer-badge"></span>
            </div>

            <div class="nav-tools">
                <button class="btn-nav" onclick="openQrModal()" title="QR Code">
                    <i class="fa-solid fa-qrcode"></i> <span class="desktop-only">QR Code</span>
                </button>
                <button class="btn-nav" onclick="openSettingsModal()" title="Configura√ß√µes">
                    <i class="fa-solid fa-gear"></i> <span class="desktop-only">Configurar</span>
                </button>
                <a id="liveLink" href="#" target="_blank" class="btn-nav btn-live" title="Ver ao Vivo">
                    <i class="fa-solid fa-arrow-up-right-from-square"></i> <span class="desktop-only">Ver Menu</span>
                </a>
                <button class="btn-nav" onclick="toggleDarkMode()" title="Tema" id="themeBtn">
                    <i class="fa-solid fa-moon" id="themeIcon"></i>
                </button>
                <button class="btn-nav" onclick="window.location.href='subscription.html'" title="Planos">
                    <i class="fa-solid fa-crown" style="color:var(--primary);"></i> <span
                        class="desktop-only">Premium</span>
                </button>
                <button class="btn-nav btn-danger-soft" onclick="signOut()" title="Sair">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>

        <!-- EDITOR CANVAS (Mimics menu.html structure but editable) -->
        <main class="editor-canvas">

            <header id="heroHeader" class="menu-header">
                <div id="coverEditor" class="cover-image editable-trigger" onclick="triggerCoverUpload()">
                    <div class="edit-overlay"><i class="fa-solid fa-camera"></i> Alterar Capa</div>
                    <input type="file" id="coverUpload" accept="image/*" style="display:none;">
                </div>

                <div class="header-content container">
                    <h1 id="restNameEditor" class="editable-text" onclick="editRestName()">Restaurante</h1>
                    <p id="restDescEditor" class="editable-text-sm" onclick="editRestDesc()">Descri√ß√£o...</p>

                    <div class="info-badges">
                        <span id="badgeWifi" class="badge editable-badge" onclick="editWifi()">
                            <i class="fa-solid fa-wifi"></i> <span id="textWifi">Wifi</span>
                        </span>
                        <span id="badgePhone" class="badge editable-badge" onclick="editPhone()">
                            <i class="fa-solid fa-phone"></i> <span id="textPhone">Tel</span>
                        </span>
                        <span id="badgeAddress" class="badge editable-badge" onclick="editAddress()">
                            <i class="fa-solid fa-location-dot"></i> <span id="textAddress">Morada</span>
                        </span>
                    </div>
                </div>
            </header>

            <!-- CATEGORY NAV -->
            <div id="categoryNav" class="category-scroll-nav sticky-nav">
                <!-- Tabs Injected via JS -->
            </div>

            <!-- MENU GRID -->
            <div class="container menu-grid-layout">
                <div id="menuContainer" class="menu-sections">
                    <!-- Items Injected via JS -->
                </div>
            </div>

            <footer class="app-footer">
                <p>Menu no Ar &copy; 2026</p>
            </footer>

        </main>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="edit-modal">
        <div class="edit-modal-content">
            <h2 style="margin-bottom:20px; color:var(--color-text);">Configura√ß√µes</h2>
            <form id="settingsForm">
                <div class="form-group">
                    <label>Link do Menu (Slug)</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-link"></i>
                        <input type="text" id="modalSlug" placeholder="ex: meurestaurante">
                    </div>
                </div>
                <div class="form-group">
                    <label>Tipo de Fonte</label>
                    <select id="modalFont">
                        <option value="Inter">Inter (Padr√£o)</option>
                        <option value="Playfair Display">Playfair Display (Elegante)</option>
                        <option value="Oswald">Oswald (Forte)</option>
                    </select>
                </div>

                <div class="form-group"
                    style="background:var(--bg-light); padding:15px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <label style="margin:0; font-size:0.9rem;">Teu Plano</label>
                        <div id="currentPlanText" style="font-weight:700; color:var(--primary);">A carregar...</div>
                    </div>
                    <a href="subscription.html" class="btn-secondary small" style="text-decoration:none;">
                        <i class="fa-solid fa-crown"></i> Upgrade
                    </a>
                </div>

                <div class="form-group"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:var(--bg-page); padding:10px; border-radius:10px;">
                    <label style="margin:0; display:flex; align-items:center; gap:8px;">
                        <i class="fa-solid fa-file-pdf"></i> Ativar Menu PDF
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="pdfToggle" onchange="togglePdfDetails()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="form-group" id="pdfDetails" style="display:none; animation: fadeIn 0.3s;">
                    <label>Upload do PDF</label>

                    <div class="file-upload-wrapper" onclick="document.getElementById('pdfUploadInput').click()">
                        <div class="upload-icon">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                        </div>
                        <div class="upload-text">
                            <span id="pdfFileNameDisplay">Clique para selecionar o PDF</span>
                            <small>Tamanho m√°x: 10MB</small>
                        </div>
                    </div>
                    <input type="file" id="pdfUploadInput" style="display:none;" accept="application/pdf"
                        onchange="handlePdfSelect(this)">

                    <p style="font-size:0.8rem; color:#888; margin-top:8px; display:flex; gap:5px;">
                        <i class="fa-solid fa-circle-info"></i>
                        Se ativo, os clientes ver√£o o PDF em vez do menu digital.
                    </p>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('settingsModal')">Cancelar</button>
                    <button type="submit" class="btn-confirm">Guardar Configura√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ITEM EDIT MODAL -->
    <div id="itemModal" class="edit-modal">
        <div class="edit-modal-content">
            <h2 id="modalTitle" style="margin-bottom:20px; color:var(--color-text);">Editar Produto</h2>
            <form id="itemEditForm">
                <input type="hidden" id="editItemId">
                <div class="form-group">
                    <label>Nome do Prato</label>
                    <input type="text" id="editItemName" required>
                </div>
                <div class="form-group">
                    <label>Pre√ßo (‚Ç¨)</label>
                    <input type="number" step="0.01" id="editItemPrice" required>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea id="editItemDesc" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <input list="catSuggestions" id="editItemCat" required>
                    <datalist id="catSuggestions">
                        <option value="Entradas">
                        <option value="Pratos Principais">
                        <option value="Sobremesas">
                        <option value="Bebidas">
                    </datalist>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('itemModal')">Cancelar</button>
                    <button type="submit" class="btn-confirm">Guardar Prato</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SETUP WIZARD MODAL -->
    <div id="setupModal" class="edit-modal" style="z-index: 99999;">
        <div class="edit-modal-content" style="max-width: 500px; text-align: center;">
            <div style="margin-bottom: 20px;">
                <img src="assets/images/logo.svg" alt="Logo" style="height: 60px; margin-bottom: 15px;">
                <h2 style="color:var(--primary);">Bem-vindo Chef! üë®‚Äçüç≥</h2>
                <p style="color:var(--text-muted);">Vamos configurar o teu restaurante em 30 segundos.</p>
            </div>

            <form id="setupForm" style="text-align: left;">
                <div class="form-group">
                    <label>Nome do Restaurante</label>
                    <input type="text" id="setupName" placeholder="ex: O Tasco do Z√©" required
                        oninput="generateSlug(this.value)">
                </div>

                <div class="form-group">
                    <label>Link Personalizado (Slug)</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-link"></i>
                        <input type="text" id="setupSlug" placeholder="ex: o-tasco-do-ze" required>
                    </div>
                    <small style="font-size: 0.8rem; color: var(--text-muted);">Ser√° o teu link:
                        menunoar.com/menu.html?id=<b>slug</b></small>
                </div>

                <div class="form-group">
                    <label>Descri√ß√£o Curta</label>
                    <textarea id="setupDesc" rows="2"
                        placeholder="ex: A melhor comida tradicional de Lisboa..."></textarea>
                </div>

                <div class="form-group"
                    style="background:var(--bg-page); padding:15px; border-radius:8px; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="setupDemo" checked
                        style="width:20px; height:20px; accent-color:var(--primary);">
                    <label for="setupDemo" style="margin:0; cursor:pointer;">
                        <strong>Adicionar pratos de exemplo?</strong><br>
                        <span style="font-size:0.85rem; font-weight:normal;">Cria categorias e pratos para n√£o come√ßares
                            do zero.</span>
                    </label>
                </div>

                <button type="submit" class="btn-confirm"
                    style="width: 100%; margin-top: 10px; font-size: 1.1rem; padding: 12px;">Criar Menu M√°gico
                    ‚ú®</button>
            </form>
        </div>
    </div>

    <!-- IMAGE PREVIEW MODAL -->
    <div id="imageModal" class="edit-modal">
        <div class="edit-modal-content" style="text-align:center; max-width:400px;">
            <h2 style="margin-bottom:15px; color:var(--text);">Imagem do Prato</h2>

            <div id="imgPreviewContainer"
                style="width:100%; height:250px; background:#f5f5f5; border-radius:12px; overflow:hidden; margin-bottom:20px; display:flex; align-items:center; justify-content:center;">
                <img id="imgPreviewDisplay" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
                <i id="imgPreviewPlaceholder" class="fa-solid fa-image" style="font-size:3rem; color:#ccc;"></i>
            </div>

            <div class="modal-actions" style="justify-content:center; flex-wrap:wrap; gap:10px;">
                <button class="btn-secondary small" onclick="closeModal('imageModal')">Fechar</button>
                <button class="btn-secondary small" id="btnRemoveImage" style="color:#ef4444; border-color:#fee2e2;">
                    <i class="fa-solid fa-trash"></i> Remover
                </button>
                <button class="btn-confirm small" id="btnChangeImage">
                    <i class="fa-solid fa-camera"></i> Alterar
                </button>
            </div>

            <input type="file" id="modalImageUpload" accept="image/*" style="display:none;">
        </div>
    </div>

    <!-- GENERIC TEXT EDIT MODAL -->
    <div id="textModal" class="edit-modal">
        <div class="edit-modal-content">
            <h2 id="textModalTitle">Editar Texto</h2>
            <div class="form-group">
                <input type="text" id="textInput" placeholder="Escreve aqui...">
                <textarea id="textAreaInput" rows="4" style="display:none;" placeholder="Escreve aqui..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('textModal')">Cancelar</button>
                <button id="saveTextBtn" class="btn-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- QR CODE MODAL -->
    <div id="qrModal" class="edit-modal">
        <div class="edit-modal-content" style="text-align:center;">
            <h2 style="margin-bottom:20px; color:var(--text);">O Teu QR Code</h2>
            <div id="qr-code-container" style="margin: 0 auto 20px auto; display:flex; justify-content:center;"></div>
            <p style="margin-bottom:20px; color:var(--text-muted);">Imprime este c√≥digo e coloca-o nas mesas.</p>
            <div class="modal-actions" style="justify-content:center;">
                <button class="btn-cancel" onclick="closeModal('qrModal')">Fechar</button>
                <button class="btn-confirm" onclick="downloadQr()">
                    <i class="fa-solid fa-download" style="margin-right:8px;"></i> Baixar PNG
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="js/dashboard.js"></script>
    <script>
        // Check for dark mode preference and set initial logo
        if (localStorage.getItem('menu_theme') === 'dark') {
            document.body.classList.add('dark-mode');
            const logo = document.getElementById('dashboardLogo');
            if (logo) logo.src = 'assets/images/Ilogo.svg';
            const btnIcon = document.querySelector('#themeBtn i');
            if (btnIcon) btnIcon.className = 'fa-solid fa-sun';
        }

        // Helper for PDF file name display
        function handlePdfSelect(input) {
            const fileName = input.files[0] ? input.files[0].name : "Clique para selecionar o PDF";
            document.getElementById('pdfFileNameDisplay').textContent = fileName;
            document.querySelector('.file-upload-wrapper').classList.add('selected');
        }
    </script>
</body>

</html>