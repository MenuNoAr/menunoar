<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão - Menu no Ar</title>
    <meta name="description"
        content="Gere o seu menu digital de forma simples e profissional com o Menu no Ar. Editor em tempo real, QR Code e muito mais.">
    <meta name="keywords" content="menu digital, qr code restaurante, e-menu, gestão restaurante, portugal">
    <link rel="icon" type="image/svg+xml" href="assets/images/logo.svg">

    <!-- Open Graph / Social -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Menu no Ar - Gestão de Menu Digital">
    <meta property="og:description" content="O editor de menus mais rápido e intuitivo para o seu restaurante.">
    <meta property="og:image" content="assets/images/logo.svg">

    <!-- Preconnect to Font Provider -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Plus+Jakarta+Sans:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        media="print" onload="this.media='all'">

    <!-- Menu Styles (Visuals for preview) -->
    <link rel="stylesheet" href="css/menu.css?v=1.1">
    <!-- Editor Styles (Overlays) -->
    <link rel="stylesheet" href="css/editor.css?v=3.2">

    <!-- Defer non-critical scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js" defer></script>
</head>

<body>

    <!-- SETUP SCREEN (Visible only if no restaurant) -->
    <div id="setup-screen" class="setup-container" style="display:none;">
        <div class="setup-card" id="setup-choice-card">
            <div class="setup-header">
                <img src="assets/images/logo.svg" alt="Logo" class="setup-logo">
                <h2>Bem-vindo, <span id="setupGreetingName">!</span></h2>
                <p>Já tens um menu ou queres começar do zero?</p>
            </div>
            <div class="setup-actions" style="display:flex; flex-direction:column; gap:15px; margin-top: 20px;">
                <button type="button" class="btn-confirm btn-full" onclick="showSetupForm('import')">
                    <i class="fa-solid fa-file-import"></i> Já tenho um menu (Importar)
                </button>
                <button type="button" class="btn-secondary btn-full" onclick="showSetupForm('scratch')">
                    <i class="fa-solid fa-plus"></i> Criar do Zero
                </button>
            </div>
        </div>

        <div class="setup-card" id="setup-form-card" style="display:none;">
            <button type="button" class="btn-cancel" onclick="goBackToSetupChoice()"
                style="margin-bottom: 20px; width: 100%;">
                <i class="fa-solid fa-arrow-left"></i> Voltar
            </button>
            <div class="setup-header">
                <h2>Criar Menu do Zero</h2>
                <p>Vamos dar vida ao teu menu digital.</p>
            </div>
            <form id="setupForm" class="setup-form">
                <div class="form-group">
                    <label for="setupName">Nome do Restaurante</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-store"></i>
                        <input type="text" id="setupName" placeholder="ex: O Tasco do Zé" required
                            oninput="generateSlug(this.value)">
                    </div>
                </div>

                <div class="form-group">
                    <label for="setupSlug">Link Personalizado</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-link"></i>
                        <input type="text" id="setupSlug" placeholder="ex: o-tasco-do-ze" required>
                    </div>
                    <small>menunoar.com/menu.html?id=<b id="slugPreview">slug</b></small>
                </div>

                <div class="form-group">
                    <label for="setupDesc">Descrição Curta</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-align-left"></i>
                        <textarea id="setupDesc" rows="2" placeholder="Descreve o teu espaço..."></textarea>
                    </div>
                </div>

                <div class="form-checkbox-group">
                    <input type="checkbox" id="setupDemo" checked>
                    <label for="setupDemo">
                        <strong>Adicionar pratos de exemplo?</strong>
                        <span>Cria categorias e pratos iniciais para te ajudar a começar.</span>
                    </label>
                </div>

                <button type="submit" class="btn-confirm btn-full">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Criar Menu
                </button>
            </form>
        </div>

        <div class="setup-card" id="setup-import-card" style="display:none;">
            <button type="button" class="btn-cancel" onclick="goBackToSetupChoice()"
                style="margin-bottom: 20px; width: 100%;">
                <i class="fa-solid fa-arrow-left"></i> Voltar
            </button>
            <div class="setup-header">
                <h2>Importar Menu</h2>
                <p>Envia-nos o teu menu ou dados básicos. A nossa equipa trata do resto!</p>
            </div>
            <form id="importForm" class="setup-form">
                <div class="form-group">
                    <label for="importRestName">Nome do Restaurante</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-store"></i>
                        <input type="text" id="importRestName" required placeholder="ex: O Tasco do Zé">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ficheiro do Menu Acual (Opcional)</label>
                    <div class="file-upload-wrapper" onclick="document.getElementById('importFile').click()"
                        style="margin-top: 5px;">
                        <div class="upload-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
                        <div class="upload-text">
                            <span id="importFileNameDisplay">Clique para selecionar PDF ou Imagem</span>
                        </div>
                    </div>
                    <input type="file" id="importFile" accept=".pdf,image/*" style="display:none;"
                        onchange="document.getElementById('importFileNameDisplay').textContent = this.files[0] ? this.files[0].name : 'Clique para selecionar PDF ou Imagem'">
                </div>
                <div class="form-group">
                    <label for="importLink">Link do Menu (Opcional)</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-link"></i>
                        <input type="url" id="importLink" placeholder="ex: https://meumenu.com">
                    </div>
                </div>
                <button type="submit" class="btn-confirm btn-full">
                    <i class="fa-solid fa-paper-plane"></i> Enviar Pedido
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN DASHBOARD (Hidden by default until loaded) -->
    <div id="main-dashboard" style="display:none;">

        <div class="dashboard-navbar">
            <div class="nav-brand">
                <img id="dashboardLogo" src="assets/images/logo.svg" alt="MenuNoAr">
                <span class="divider">|</span>
                <button id="userDisplay" class="user-name-btn" onclick="openRenameModal()"
                    title="Clica para alterar o nome">
                    <span id="userDisplayName">...</span>
                    <i class="fa-solid fa-pen-to-square user-edit-icon"></i>
                </button>
            </div>

            <div class="nav-tools">
                <button class="btn-nav" onclick="openQrModal()" title="QR Code">
                    <i class="fa-solid fa-qrcode"></i> <span class="desktop-only">QR Code</span>
                </button>
                <button class="btn-nav" id="liveLinkBtn" title="Ver ao Vivo">
                    <i class="fa-solid fa-arrow-up-right-from-square"></i> <span class="desktop-only">Ver Menu</span>
                </button>
                <button class="btn-nav" onclick="openSettingsModal()" title="Configurações">
                    <i class="fa-solid fa-gear"></i> <span class="desktop-only">Configurar</span>
                </button>
                <button class="btn-nav" onclick="toggleDarkMode()" title="Tema">
                    <i class="fa-solid fa-moon" id="themeIcon"></i>
                </button>
                <button class="btn-nav" onclick="window.location.href='subscription.html'" title="Planos">
                    <i class="fa-solid fa-crown" style="color:var(--primary);"></i> <span
                        class="desktop-only">Premium</span>
                </button>
                <button class="btn-nav" onclick="openTutorial()" title="Tutorial" style="position:relative;">
                    <i class="fa-solid fa-graduation-cap"></i> <span class="desktop-only">Ajuda</span>
                    <span class="badge-pulse">NOVO</span>
                </button>
                <button class="btn-nav btn-danger-soft" onclick="signOut()" title="Sair">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>

        <!-- EDITOR CANVAS (Mimics menu.html structure but editable) -->
        <main class="editor-canvas">

            <header id="heroHeader" class="menu-header">
                <div id="coverEditor" class="cover-image editable-trigger" onclick="triggerCoverUpload()">
                    <div class="edit-overlay"><i class="fa-solid fa-camera"></i> Alterar Capa</div>
                    <input type="file" id="coverUpload" accept="image/*" style="display:none;">
                </div>

                <div class="header-content container">
                    <!-- Inline Editable Fields -->
                    <h1 id="restNameEditor" class="inline-editable">Restaurante</h1>
                    <p id="restDescEditor" class="inline-editable">Descrição...</p>

                    <div class="info-badges">
                        <span id="badgeWifi" class="badge">
                            <i class="fa-solid fa-wifi"></i> <span id="textWifi" class="inline-editable">Wifi</span>
                        </span>
                        <span id="badgePhone" class="badge">
                            <i class="fa-solid fa-phone"></i> <span id="textPhone" class="inline-editable">Tel</span>
                        </span>
                        <span id="badgeAddress" class="badge">
                            <i class="fa-solid fa-location-dot"></i> <span id="textAddress"
                                class="inline-editable">Morada</span>
                        </span>
                    </div>
                </div>
            </header>

            <!-- CATEGORY NAV -->
            <div id="categoryNav" class="category-scroll-nav sticky-nav">
                <!-- Tabs Injected via JS -->
            </div>

            <!-- MENU GRID -->
            <div class="container menu-grid-layout">
                <div id="menuContainer" class="menu-sections">
                    <!-- Items Injected via JS -->
                </div>
            </div>

            <footer class="app-footer">
                <p>Menu no Ar &copy; 2026</p>
            </footer>

        </main>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="edit-modal">
        <div class="edit-modal-content">
            <h2 style="margin-bottom:20px; color:var(--color-text);">Configurações</h2>
            <form id="settingsForm">
                <div class="form-group">
                    <label>Link do Menu (Slug)</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-link"></i>
                        <input type="text" id="modalSlug" placeholder="ex: meurestaurante">
                    </div>
                </div>
                <div class="form-group">
                    <label>Tipo de Fonte</label>
                    <select id="modalFont">
                        <option value="Inter">Inter (Padrão)</option>
                        <option value="Playfair Display">Playfair Display (Elegante)</option>
                        <option value="Oswald">Oswald (Forte)</option>
                    </select>
                </div>

                <div class="form-group"
                    style="background:var(--bg-light); padding:15px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <label style="margin:0; font-size:0.9rem;">Teu Plano</label>
                        <div id="currentPlanText" style="font-weight:700; color:var(--primary);">A carregar...</div>
                    </div>
                    <a href="subscription.html" class="btn-secondary small" style="text-decoration:none;">
                        <i class="fa-solid fa-crown"></i> Upgrade
                    </a>
                </div>

                <div class="form-group"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:var(--bg-page); padding:10px; border-radius:10px;">
                    <label style="margin:0; display:flex; align-items:center; gap:8px;">
                        <i class="fa-solid fa-file-pdf"></i> Ativar Menu PDF
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="pdfToggle" onchange="togglePdfDetails()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="form-group" id="pdfDetails" style="display:none; animation: fadeIn 0.3s;">
                    <label>Upload do PDF</label>

                    <div class="file-upload-wrapper" onclick="document.getElementById('pdfUploadInput').click()">
                        <div class="upload-icon">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                        </div>
                        <div class="upload-text">
                            <span id="pdfFileNameDisplay">Clique para selecionar o PDF</span>
                            <small>Tamanho máx: 10MB</small>
                        </div>
                    </div>
                    <input type="file" id="pdfUploadInput" style="display:none;" accept="application/pdf"
                        onchange="handlePdfSelect(this)">

                    <p style="font-size:0.8rem; color:#888; margin-top:8px; display:flex; gap:5px;">
                        <i class="fa-solid fa-circle-info"></i>
                        Se ativo, os clientes verão o PDF em vez do menu digital.
                    </p>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('settingsModal')">Cancelar</button>
                    <button type="submit" class="btn-confirm">Guardar Configurações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ITEM EDIT MODAL -->
    <div id="itemModal" class="edit-modal">
        <div class="edit-modal-content">
            <h2 id="modalTitle" style="margin-bottom:20px; color:var(--color-text);">Editar Produto</h2>
            <form id="itemEditForm">
                <input type="hidden" id="editItemId">
                <div class="form-group">
                    <label>Nome do Prato</label>
                    <input type="text" id="editItemName" required>
                </div>
                <div class="form-group">
                    <label>Preço (€)</label>
                    <input type="number" step="0.01" id="editItemPrice" required>
                </div>
                <div class="form-group">
                    <label>Descrição</label>
                    <textarea id="editItemDesc" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <input list="catSuggestions" id="editItemCat" required>
                    <datalist id="catSuggestions">
                        <option value="Entradas">
                        <option value="Pratos Principais">
                        <option value="Sobremesas">
                        <option value="Bebidas">
                    </datalist>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('itemModal')">Cancelar</button>
                    <button type="submit" class="btn-confirm">Guardar Prato</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SETUP WIZARD MODAL REMOVED (DUPLICATE OF SETUP SCREEN) -->

    <!-- IMAGE PREVIEW MODAL -->
    <div id="imageModal" class="edit-modal">
        <div class="edit-modal-content" style="text-align:center; max-width:400px;">
            <h2 style="margin-bottom:15px; color:var(--text);">Imagem do Prato</h2>

            <div id="imgPreviewContainer"
                style="width:100%; height:250px; background:#f5f5f5; border-radius:12px; overflow:hidden; margin-bottom:20px; display:flex; align-items:center; justify-content:center;">
                <img id="imgPreviewDisplay" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
                <i id="imgPreviewPlaceholder" class="fa-solid fa-image" style="font-size:3rem; color:#ccc;"></i>
            </div>

            <div class="modal-actions" style="justify-content:center; flex-wrap:wrap; gap:10px;">
                <button class="btn-secondary small" onclick="closeModal('imageModal')">Fechar</button>
                <button class="btn-secondary small" id="btnRemoveImage" style="color:#ef4444; border-color:#fee2e2;">
                    <i class="fa-solid fa-trash"></i> Remover
                </button>
                <button class="btn-confirm small" id="btnChangeImage">
                    <i class="fa-solid fa-camera"></i> Alterar
                </button>
            </div>

            <input type="file" id="modalImageUpload" accept="image/*" style="display:none;">
        </div>
    </div>

    <!-- GENERIC TEXT EDIT MODAL REMOVED -->

    <!-- QR CODE MODAL -->
    <div id="qrModal" class="edit-modal">
        <div class="edit-modal-content" style="text-align:center; max-width:480px;">
            <h2 style="margin-bottom:20px; color:var(--text);">O Teu QR Code</h2>

            <!-- QR Preview -->
            <div id="qr-code-container" style="margin: 0 auto 20px auto; display:flex; justify-content:center;"></div>

            <!-- Logo Customizer -->
            <div class="qr-logo-section">

                <div class="qr-logo-row">
                    <div id="qrLogoPreview" class="qr-logo-preview">
                        <img id="qrLogoImg" src="assets/images/logo.svg" alt="Logo QR">
                    </div>
                    <div class="qr-logo-actions">
                        <button class="btn-secondary small" onclick="document.getElementById('qrLogoUpload').click()">
                            <i class="fa-solid fa-upload"></i> Trocar Logo
                        </button>
                        <button class="btn-secondary small" id="btnResetQrLogo" onclick="resetQrLogo()"
                            style="display:none;">
                            <i class="fa-solid fa-rotate-left"></i> Repor Padrão
                        </button>
                    </div>
                </div>
                <input type="file" id="qrLogoUpload" accept="image/*" style="display:none;"
                    onchange="handleQrLogoChange(this)">
            </div>

            <p style="margin:16px 0 20px; color:var(--text-muted); font-size:0.875rem;">Imprime este código e coloca-o
                nas mesas.</p>

            <div class="modal-actions" style="justify-content:center;">
                <button class="btn-cancel" onclick="closeModal('qrModal')">Fechar</button>
                <button class="btn-confirm" onclick="downloadQr()">
                    <i class="fa-solid fa-download" style="margin-right:8px;"></i>Baixar PNG
                </button>
            </div>
        </div>
    </div>



    <!-- RENAME MODAL -->
    <div id="renameModal" class="edit-modal">
        <div class="edit-modal-content" style="max-width:380px;">
            <h2 style="margin-bottom:6px; color:var(--color-text);">Alterar Nome</h2>
            <p style="color:var(--text-muted); font-size:0.875rem; margin-bottom:20px;">Este nome é apenas para
                referência pessoal no painel.</p>
            <form id="renameForm">
                <div class="form-group">
                    <label>O teu nome</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-user"></i>
                        <input type="text" id="renameInput" placeholder="ex: João Silva" maxlength="40" required>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('renameModal')">Cancelar</button>
                    <button type="submit" class="btn-confirm">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SORTABLE, CONFETTI, ETC -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- Scripts -->
    <script type="module" src="js/dashboard.js?v=3.1"></script>
    <script type="module">
        // Inline helpers moved to module scope for cleanliness
        window.handlePdfSelect = (input) => {
            const fileName = input.files[0] ? input.files[0].name : "Clique para selecionar o PDF";
            const display = document.getElementById('pdfFileNameDisplay');
            if (display) display.textContent = fileName;
            const wrapper = document.querySelector('.file-upload-wrapper');
            if (wrapper) wrapper.classList.add('selected');
        };

        // Dark mode initial sync
        if (localStorage.getItem('menu_theme') === 'dark') {
            document.body.classList.add('dark-mode');
            const logo = document.getElementById('dashboardLogo');
            if (logo) logo.src = 'assets/images/Ilogo.svg';
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) themeIcon.className = 'fa-solid fa-sun';
        }
    </script>
</body>

</html>