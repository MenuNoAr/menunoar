<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Menu no Ar</title>
    <link rel="icon" type="image/svg+xml" href="assets/images/logo.svg">

    <!-- Preconnect to Font Provider -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Plus+Jakarta+Sans:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        media="print" onload="this.media='all'">

    <!-- Menu Styles (Visuals for preview) -->
    <link rel="stylesheet" href="css/menu.css">
    <!-- Editor Styles (Overlays) -->
    <link rel="stylesheet" href="css/editor.css">

    <!-- Defer non-critical scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js" defer></script>
</head>

<body>

    <!-- SETUP SCREEN (Visible only if no restaurant) -->
    <div id="setup-screen" class="setup-container" style="display:none;">
        <div class="setup-card">
            <div class="setup-header" style="margin-bottom: 35px;">
                <img src="assets/images/logo.svg" alt="Logo" class="setup-logo"
                    style="height: 70px; margin-bottom: 20px;">
                <h2 style="font-size: 2.2rem; letter-spacing: -1px;">Bem-vindo, Chef!</h2>
                <p style="font-size: 1.1rem;">Vamos dar vida ao teu menu digital.</p>
            </div>

            <form id="setupForm" class="setup-form">
                <div class="form-group">
                    <label>Nome do Restaurante</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-store"></i>
                        <input type="text" id="setupName" placeholder="ex: O Tasco do Z√©" required
                            oninput="generateSlug(this.value)">
                    </div>
                </div>

                <div class="form-group">
                    <label>Link Personalizado</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-link"></i>
                        <input type="text" id="setupSlug" placeholder="ex: o-tasco-do-ze" required>
                    </div>
                    <small>menunoar.com/menu.html?id=<b>slug</b></small>
                </div>

                <div class="form-group">
                    <label>Descri√ß√£o Curta</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-align-left"></i>
                        <textarea id="setupDesc" rows="2" placeholder="Descreve o teu espa√ßo..."></textarea>
                    </div>
                </div>

                <div class="form-checkbox-group">
                    <input type="checkbox" id="setupDemo" checked style="width: auto; margin-right: 10px;">
                    <label for="setupDemo">
                        <strong>Adicionar pratos de exemplo?</strong>
                        <span>Cria categorias e pratos iniciais.</span>
                    </label>
                </div>

                <button type="submit" class="btn-confirm btn-full">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Criar Menu
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN DASHBOARD (Hidden by default until loaded) -->
    <div id="main-dashboard" style="display:none;">

        <div class="dashboard-navbar">
            <div class="nav-brand">
                <img id="dashboardLogo" src="assets/images/logo.svg" alt="MenuNoAr">
                <span class="divider">|</span>
                <span id="userDisplay">Chef</span>
            </div>

            <div class="nav-tools">
                <button class="btn-nav" onclick="openQrModal()" title="QR Code">
                    <i class="fa-solid fa-qrcode"></i> <span class="desktop-only">QR Code</span>
                </button>
                <button class="btn-nav" id="liveLinkBtn" title="Ver ao Vivo">
                    <i class="fa-solid fa-arrow-up-right-from-square"></i> <span class="desktop-only">Ver Menu</span>
                </button>
                <button class="btn-nav" onclick="openSettingsModal()" title="Configura√ß√µes">
                    <i class="fa-solid fa-gear"></i> <span class="desktop-only">Configurar</span>
                </button>
                <button class="btn-nav" onclick="toggleDarkMode()" title="Tema">
                    <i class="fa-solid fa-moon" id="themeIcon"></i>
                </button>
                <button class="btn-nav" onclick="window.location.href='subscription.html'" title="Planos">
                    <i class="fa-solid fa-crown" style="color:var(--primary);"></i> <span
                        class="desktop-only">Premium</span>
                </button>
                <button class="btn-nav" onclick="openTutorial()" title="Tutorial">
                    <i class="fa-solid fa-graduation-cap"></i> <span class="desktop-only">Ajuda</span>
                </button>
                <button class="btn-nav btn-danger-soft" onclick="signOut()" title="Sair">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>

        <!-- EDITOR CANVAS (Mimics menu.html structure but editable) -->
        <main class="editor-canvas">

            <header id="heroHeader" class="menu-header">
                <div id="coverEditor" class="cover-image editable-trigger" onclick="triggerCoverUpload()">
                    <div class="edit-overlay"><i class="fa-solid fa-camera"></i> Alterar Capa</div>
                    <input type="file" id="coverUpload" accept="image/*" style="display:none;">
                </div>

                <div class="header-content container">
                    <!-- Inline Editable Fields -->
                    <h1 id="restNameEditor" class="inline-editable">Restaurante</h1>
                    <p id="restDescEditor" class="inline-editable">Descri√ß√£o...</p>

                    <div class="info-badges">
                        <span id="badgeWifi" class="badge">
                            <i class="fa-solid fa-wifi"></i> <span id="textWifi" class="inline-editable">Wifi</span>
                        </span>
                        <span id="badgePhone" class="badge">
                            <i class="fa-solid fa-phone"></i> <span id="textPhone" class="inline-editable">Tel</span>
                        </span>
                        <span id="badgeAddress" class="badge">
                            <i class="fa-solid fa-location-dot"></i> <span id="textAddress"
                                class="inline-editable">Morada</span>
                        </span>
                    </div>
                </div>
            </header>

            <!-- CATEGORY NAV -->
            <div id="categoryNav" class="category-scroll-nav sticky-nav">
                <!-- Tabs Injected via JS -->
            </div>

            <!-- MENU GRID -->
            <div class="container menu-grid-layout">
                <div id="menuContainer" class="menu-sections">
                    <!-- Items Injected via JS -->
                </div>
            </div>

            <footer class="app-footer">
                <p>Menu no Ar &copy; 2026</p>
            </footer>

        </main>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="edit-modal">
        <div class="edit-modal-content">
            <h2 style="margin-bottom:20px; color:var(--color-text);">Configura√ß√µes</h2>
            <form id="settingsForm">
                <div class="form-group">
                    <label>Link do Menu (Slug)</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-link"></i>
                        <input type="text" id="modalSlug" placeholder="ex: meurestaurante">
                    </div>
                </div>
                <div class="form-group">
                    <label>Tipo de Fonte</label>
                    <select id="modalFont">
                        <option value="Inter">Inter (Padr√£o)</option>
                        <option value="Playfair Display">Playfair Display (Elegante)</option>
                        <option value="Oswald">Oswald (Forte)</option>
                    </select>
                </div>

                <div class="form-group"
                    style="background:var(--bg-light); padding:15px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <label style="margin:0; font-size:0.9rem;">Teu Plano</label>
                        <div id="currentPlanText" style="font-weight:700; color:var(--primary);">A carregar...</div>
                    </div>
                    <a href="subscription.html" class="btn-secondary small" style="text-decoration:none;">
                        <i class="fa-solid fa-crown"></i> Upgrade
                    </a>
                </div>

                <div class="form-group"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:var(--bg-page); padding:10px; border-radius:10px;">
                    <label style="margin:0; display:flex; align-items:center; gap:8px;">
                        <i class="fa-solid fa-file-pdf"></i> Ativar Menu PDF
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="pdfToggle" onchange="togglePdfDetails()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="form-group" id="pdfDetails" style="display:none; animation: fadeIn 0.3s;">
                    <label>Upload do PDF</label>

                    <div class="file-upload-wrapper" onclick="document.getElementById('pdfUploadInput').click()">
                        <div class="upload-icon">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                        </div>
                        <div class="upload-text">
                            <span id="pdfFileNameDisplay">Clique para selecionar o PDF</span>
                            <small>Tamanho m√°x: 10MB</small>
                        </div>
                    </div>
                    <input type="file" id="pdfUploadInput" style="display:none;" accept="application/pdf"
                        onchange="handlePdfSelect(this)">

                    <p style="font-size:0.8rem; color:#888; margin-top:8px; display:flex; gap:5px;">
                        <i class="fa-solid fa-circle-info"></i>
                        Se ativo, os clientes ver√£o o PDF em vez do menu digital.
                    </p>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('settingsModal')">Cancelar</button>
                    <button type="submit" class="btn-confirm">Guardar Configura√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ITEM EDIT MODAL -->
    <div id="itemModal" class="edit-modal">
        <div class="edit-modal-content">
            <h2 id="modalTitle" style="margin-bottom:20px; color:var(--color-text);">Editar Produto</h2>
            <form id="itemEditForm">
                <input type="hidden" id="editItemId">
                <div class="form-group">
                    <label>Nome do Prato</label>
                    <input type="text" id="editItemName" required>
                </div>
                <div class="form-group">
                    <label>Pre√ßo (‚Ç¨)</label>
                    <input type="number" step="0.01" id="editItemPrice" required>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea id="editItemDesc" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <input list="catSuggestions" id="editItemCat" required>
                    <datalist id="catSuggestions">
                        <option value="Entradas">
                        <option value="Pratos Principais">
                        <option value="Sobremesas">
                        <option value="Bebidas">
                    </datalist>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('itemModal')">Cancelar</button>
                    <button type="submit" class="btn-confirm">Guardar Prato</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SETUP WIZARD MODAL -->
    <div id="setupModal" class="edit-modal" style="z-index: 99999;">
        <div class="edit-modal-content" style="max-width: 500px; text-align: center;">
            <div style="margin-bottom: 20px;">
                <img src="assets/images/logo.svg" alt="Logo" style="height: 60px; margin-bottom: 15px;">
                <h2 style="color:var(--primary);">Bem-vindo Chef! üë®‚Äçüç≥</h2>
                <p style="color:var(--text-muted);">Vamos configurar o teu restaurante em 30 segundos.</p>
            </div>

            <form id="setupForm" style="text-align: left;">
                <div class="form-group">
                    <label>Nome do Restaurante</label>
                    <input type="text" id="setupName" placeholder="ex: O Tasco do Z√©" required
                        oninput="generateSlug(this.value)">
                </div>

                <div class="form-group">
                    <label>Link Personalizado (Slug)</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-link"></i>
                        <input type="text" id="setupSlug" placeholder="ex: o-tasco-do-ze" required>
                    </div>
                    <small style="font-size: 0.8rem; color: var(--text-muted);">Ser√° o teu link:
                        menunoar.com/menu.html?id=<b>slug</b></small>
                </div>

                <div class="form-group">
                    <label>Descri√ß√£o Curta</label>
                    <textarea id="setupDesc" rows="2"
                        placeholder="ex: A melhor comida tradicional de Lisboa..."></textarea>
                </div>

                <div class="form-group"
                    style="background:var(--bg-page); padding:15px; border-radius:8px; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="setupDemo" checked
                        style="width:20px; height:20px; accent-color:var(--primary);">
                    <label for="setupDemo" style="margin:0; cursor:pointer;">
                        <strong>Adicionar pratos de exemplo?</strong><br>
                        <span style="font-size:0.85rem; font-weight:normal;">Cria categorias e pratos para n√£o come√ßares
                            do zero.</span>
                    </label>
                </div>

                <button type="submit" class="btn-confirm"
                    style="width: 100%; margin-top: 10px; font-size: 1.1rem; padding: 12px;">Criar Menu M√°gico
                    ‚ú®</button>
            </form>

            <div
                style="margin-top: 25px; border-top: 1px solid var(--border); padding-top: 25px; display: flex; flex-direction: column; gap: 12px;">
                <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 4px; text-align: center;">√â a tua
                    primeira vez no Menu no Ar?</p>
                <button onclick="openTutorial()" class="btn-secondary btn-full"
                    style="height: 54px; border-width: 2px;">
                    <i class="fa-solid fa-graduation-cap"></i> Ver Tutorial Passo-a-Passo
                </button>
            </div>
        </div>
    </div>

    <!-- IMAGE PREVIEW MODAL -->
    <div id="imageModal" class="edit-modal">
        <div class="edit-modal-content" style="text-align:center; max-width:400px;">
            <h2 style="margin-bottom:15px; color:var(--text);">Imagem do Prato</h2>

            <div id="imgPreviewContainer"
                style="width:100%; height:250px; background:#f5f5f5; border-radius:12px; overflow:hidden; margin-bottom:20px; display:flex; align-items:center; justify-content:center;">
                <img id="imgPreviewDisplay" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
                <i id="imgPreviewPlaceholder" class="fa-solid fa-image" style="font-size:3rem; color:#ccc;"></i>
            </div>

            <div class="modal-actions" style="justify-content:center; flex-wrap:wrap; gap:10px;">
                <button class="btn-secondary small" onclick="closeModal('imageModal')">Fechar</button>
                <button class="btn-secondary small" id="btnRemoveImage" style="color:#ef4444; border-color:#fee2e2;">
                    <i class="fa-solid fa-trash"></i> Remover
                </button>
                <button class="btn-confirm small" id="btnChangeImage">
                    <i class="fa-solid fa-camera"></i> Alterar
                </button>
            </div>

            <input type="file" id="modalImageUpload" accept="image/*" style="display:none;">
        </div>
    </div>

    <!-- GENERIC TEXT EDIT MODAL REMOVED -->

    <!-- QR CODE MODAL -->
    <div id="qrModal" class="edit-modal">
        <div class="edit-modal-content" style="text-align:center;">
            <h2 style="margin-bottom:20px; color:var(--text);">O Teu QR Code</h2>
            <div id="qr-code-container" style="margin: 0 auto 20px auto; display:flex; justify-content:center;"></div>
            <p style="margin-bottom:20px; color:var(--text-muted);">Imprime este c√≥digo e coloca-o nas mesas.</p>
            <div class="modal-actions" style="justify-content:center;">
                <button class="btn-cancel" onclick="closeModal('qrModal')">Fechar</button>
                <button class="btn-confirm" onclick="downloadQr()">
                    <i class="fa-solid fa-download" style="margin-right:8px;"></i> Baixar PNG
                </button>
            </div>
        </div>
    </div>

    <!-- TUTORIAL MODAL -->
    <div id="tutorialModal" class="edit-modal">
        <div class="edit-modal-content"
            style="max-width: 600px; padding: 0; overflow: hidden; display: flex; flex-direction: column;">

            <!-- Progress Bar -->
            <div class="tutorial-progress">
                <div id="tutorialProgressBar" class="progress-fill" style="width: 20%;"></div>
            </div>

            <div class="tutorial-header"
                style="padding: 25px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fa-solid fa-graduation-cap" style="font-size: 1.5rem; color: var(--primary);"></i>
                    <h2 style="margin: 0; font-size: 1.2rem;">Tutorial do Chef</h2>
                </div>
                <button class="btn-nav" onclick="closeModal('tutorialModal')" style="padding: 8px; min-width: auto;">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div id="tutorialPages" class="tutorial-body" style="padding: 30px; min-height: 400px;">
                <!-- Page content injected via JS -->
            </div>

            <div class="tutorial-footer"
                style="padding: 20px 30px; border-top: 1px solid var(--border); background: var(--bg-page); display: flex; justify-content: space-between; align-items: center;">
                <button id="prevTutBtn" class="btn-nav" onclick="prevTutorialPage()" disabled>
                    <i class="fa-solid fa-arrow-left"></i> Anterior
                </button>
                <span id="tutPageCounter" class="tut-page-counter">P√°gina
                    1 de 5</span>
                <button id="nextTutBtn" class="btn-confirm" onclick="nextTutorialPage()">
                    Pr√≥ximo <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- SORTABLE, CONFETTI, ETC -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- Scripts -->
    <script type="module" src="js/dashboard.js"></script>
    <script>
        // Check for dark mode preference and set initial logo
        if (localStorage.getItem('menu_theme') === 'dark') {
            document.body.classList.add('dark-mode');
            const logo = document.getElementById('dashboardLogo');
            if (logo) logo.src = 'assets/images/Ilogo.svg';
            const btnIcon = document.querySelector('#themeBtn i');
            if (btnIcon) btnIcon.className = 'fa-solid fa-sun';
        }

        // Helper for PDF file name display
        function handlePdfSelect(input) {
            const fileName = input.files[0] ? input.files[0].name : "Clique para selecionar o PDF";
            document.getElementById('pdfFileNameDisplay').textContent = fileName;
            document.querySelector('.file-upload-wrapper').classList.add('selected');
        }
    </script>
</body>

</html>