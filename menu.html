<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Menu Digital</title>
    <link rel="icon" type="image/svg+xml" href="assets/images/logo.svg">
    <link rel="stylesheet" href="css/menu.css"> <!-- New dedicated CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div id="loading" class="loading-screen">
        <div class="spinner"></div>
        <p>A carregar ementa...</p>
    </div>

    <!-- Theme Toggle Button -->
    <button id="themeToggle" class="theme-toggle-btn" title="Mudar Tema">
        <i class="fa-solid fa-moon"></i>
    </button>

    <!-- Mobile Wrapper (Simulates Phone on Desktop) -->
    <div id="mobile-view">


        <!-- Header Section -->
        <header id="heroHeader">
            <div id="coverContainer" class="cover-image"></div>
            <div class="header-content">
                <h1 id="restName">Restaurante</h1>
                <p id="restDesc" class="description"></p>

                <div class="info-badges">
                    <span id="badgeWifi" style="display:none;"><i class="fa-solid fa-wifi"></i> <span
                            id="textWifi"></span></span>
                    <span id="badgePhone" style="display:none;"><i class="fa-solid fa-phone"></i> <span
                            id="textPhone"></span></span>
                    <span id="badgeAddress" style="display:none;"><i class="fa-solid fa-location-dot"></i> <span
                            id="textAddress"></span></span>
                </div>
            </div>
        </header>

        <!-- Category Tabs -->
        <div id="categoryTabs" class="category-tabs">
            <!-- Injected via JS -->
        </div>

        <!-- Carousel Window -->
        <div id="menuSliderWindow" class="slider-window">
            <div id="menuSliderTrack" class="slider-track">
                <!-- Sections Injected via JS -->
            </div>
        </div>

        <!-- Float Footer (Branding) -->
        <footer class="menu-footer">
            <p>Menu digital por <b>Menu no Ar</b></p>
        </footer>
    </div>

    <script type="module">
        let currentCategoryIndex = 0;

        // --- THEME LOGIC ---
        window.toggleDarkMode = () => {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('menu_theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);

            // If we are in dark mode, we want the static dark mode variables from CSS to win.
            // Inline styles set by the heuristic would override them, so we remove them.
            if (isDark) {
                document.documentElement.style.removeProperty('--bg-card');
                document.documentElement.style.removeProperty('--bg-badge');
                document.documentElement.style.removeProperty('--border');
                document.documentElement.style.removeProperty('--text-muted');
                document.documentElement.style.removeProperty('--bg-page');
            } else {
                // If switching back to light, we might need to re-apply the heuristic 
                // but let's keep it simple: the page reload or initial load handles it.
                // For a live toggle, it's better if we just let the default light vars win.
            }
        };


        function updateThemeIcon(isDark) {
            const icon = document.querySelector('#themeToggle i');
            if (icon) {
                icon.className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
            }
        }

        // Initial Theme Sync
        if (localStorage.getItem('menu_theme') === 'dark') {
            document.body.classList.add('dark-mode');
            updateThemeIcon(true);
        }

        document.getElementById('themeToggle').onclick = window.toggleDarkMode;


        // --- PREVIEW LISTENER ---
        window.addEventListener('message', (event) => {
            const { type, data } = event.data;
            if (type === 'previewUpdate') {
                // Texts
                if (data.name) document.getElementById('restName').textContent = data.name;
                if (data.description) document.getElementById('restDesc').textContent = data.description;

                // Wifi
                const badgeWifi = document.getElementById('badgeWifi');
                if (data.wifi_password) {
                    badgeWifi.style.display = 'inline-flex';
                    document.getElementById('textWifi').textContent = data.wifi_password;
                } else {
                    badgeWifi.style.display = 'none';
                }

                // Phone
                const badgePhone = document.getElementById('badgePhone');
                if (data.phone) {
                    badgePhone.style.display = 'inline-flex';
                    document.getElementById('textPhone').textContent = data.phone;
                } else {
                    badgePhone.style.display = 'none';
                }

                // Address
                const badgeAddress = document.getElementById('badgeAddress');
                if (data.address) {
                    badgeAddress.style.display = 'inline-flex';
                    document.getElementById('textAddress').textContent = data.address;
                } else {
                    badgeAddress.style.display = 'none';
                }

                // Font
                if (data.font) {
                    document.body.style.fontFamily = `'${data.font}', sans-serif`;
                    // Note: We can't easily load the font link dynamically here repeatedly without spamming head, 
                    // but usually the font is already loaded or we assume user won't switch 100 times quickly.
                    // For now simplest is setting family.
                }

                // Colors
                if (data.color_background) {
                    const bg = data.color_background;
                    document.documentElement.style.setProperty('--bg-mobile', bg);
                    document.getElementById('mobile-view').style.background = bg;

                    const isDark = bg.toLowerCase() === '#1a1a1a' || bg.toLowerCase() === '#121212' || bg.toLowerCase() === '#000000';
                    if (isDark) {
                        document.documentElement.style.setProperty('--bg-card', '#252525');
                        document.documentElement.style.setProperty('--bg-badge', '#333333');
                        document.documentElement.style.setProperty('--border', '#333333');
                        document.documentElement.style.setProperty('--text-muted', '#a0a0a0');
                        document.documentElement.style.setProperty('--bg-page', '#121212');
                    } else {
                        document.documentElement.style.setProperty('--bg-card', '#FFFFFF');
                        document.documentElement.style.setProperty('--bg-badge', '#F5F7FA');
                        document.documentElement.style.setProperty('--border', '#F0F0F0');
                        document.documentElement.style.setProperty('--text-muted', '#666666');
                        document.documentElement.style.setProperty('--bg-page', '#F0F2F5');
                    }
                }
            } else if (type === 'previewUpdateCover') {
                const url = data;
                if (url) {
                    const el = document.getElementById('coverContainer');
                    el.style.display = 'block';
                    el.style.backgroundImage = `url('${url}')`;
                }
            }
        });

        async function init() {
            const res = await fetch('/api/config');
            const config = await res.json();
            const supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
            const params = new URLSearchParams(window.location.search);
            const slug = params.get('id');

            if (!slug) return document.body.innerHTML = '<h1 style="padding:20px;">Restaurante não encontrado.</h1>';

            // Fetch Restaurant & Items
            const { data: restaurant } = await supabase.from('restaurants').select('*').eq('slug', slug).single();
            if (!restaurant) return document.body.innerHTML = '<h1 style="padding:20px;">404 - Restaurante não encontrado.</h1>';

            // PDF MODE CHECK
            if (restaurant.menu_type === 'pdf' && restaurant.pdf_url) {
                const pdfContainer = document.createElement('div');
                pdfContainer.id = 'pdf-reels-container';
                pdfContainer.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background: #1a1a1a; overflow-y:scroll; overflow-x:hidden; scroll-snap-type: y mandatory; display: flex; flex-direction: column; align-items: center; -webkit-overflow-scrolling: touch; z-index: 50;';
                pdfContainer.innerHTML = `
                    <div id="pdfLoading" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); display:flex; flex-direction:column; align-items:center; z-index:100;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size:3rem; color:#fff; margin-bottom:15px;"></i>
                        <p style="color:#fff; font-weight:500; font-family: 'Outfit', sans-serif;">A preparar menu...</p>
                    </div>
                `;
                document.body.appendChild(pdfContainer);
                document.getElementById('mobile-view')?.remove();
                document.getElementById('loading')?.remove();


                // Load PDF.js dynamically
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = () => {
                    const pdfjsLib = window['pdfjs-dist/build/pdf'];
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

                    const loadingTask = pdfjsLib.getDocument(restaurant.pdf_url);
                    loadingTask.promise.then(async (pdf) => {
                        const container = document.getElementById('pdf-reels-container');
                        document.getElementById('pdfLoading').style.display = 'none';

                        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                            // Reel Slide Wrapper
                            const wrapper = document.createElement('div');
                            wrapper.style.cssText = 'width:100vw; height:100vh; flex-shrink:0; display:flex; justify-content:center; align-items:center; scroll-snap-align: start; padding: 15px; box-sizing:border-box; position:relative;';

                            // Visual indicator for drag/swipe if there are multiple pages
                            if (pdf.numPages > 1 && pageNum < pdf.numPages) {
                                const swipeHint = document.createElement('div');
                                swipeHint.innerHTML = '<i class="fa-solid fa-angles-down" style="color:rgba(255,255,255,0.5); font-size:1.5rem; animation: pulse 2s infinite;"></i>';
                                swipeHint.style.cssText = 'position:absolute; bottom:20px; left:50%; transform:translateX(-50%); z-index:10; pointer-events:none;';
                                wrapper.appendChild(swipeHint);

                                // Keyframes injected once
                                if (pageNum === 1) {
                                    const style = document.createElement('style');
                                    style.innerHTML = '@keyframes pulse { 0% { opacity:0.3; transform:translateY(0); } 50% { opacity:0.8; transform:translateY(10px); } 100% { opacity:0.3; transform:translateY(0); } }';
                                    document.head.appendChild(style);
                                }
                            }

                            const canvas = document.createElement('canvas');
                            canvas.style.cssText = 'max-width:100%; max-height:100%; box-shadow: 0 10px 30px rgba(0,0,0,0.5); object-fit:contain; border-radius: 4px; background:#fff; opacity:0; transition: opacity 0.4s;';

                            wrapper.appendChild(canvas);
                            container.appendChild(wrapper);

                            // Render PDF page to canvas
                            const page = await pdf.getPage(pageNum);
                            // Use scale 2.0 to assure sharpness on high-DPI screens (Retina/Mobile)
                            const viewport = page.getViewport({ scale: 2.0 });
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            const renderContext = { canvasContext: context, viewport: viewport };
                            await page.render(renderContext).promise;

                            // Free space footer
                            if (pageNum === pdf.numPages) {
                                const footer = document.createElement('div');
                                footer.innerHTML = 'Feito com <b><a href="https://menunoar.pt" target="_blank" style="color:#fff; text-decoration:none;">menunoar.pt</a></b>';
                                footer.style.cssText = 'position:absolute; bottom:20px; left:50%; transform:translateX(-50%); color:rgba(255,255,255,0.4); font-size:0.8rem; font-family:"Outfit", sans-serif; white-space:nowrap; z-index:10; pointer-events:auto;';
                                wrapper.appendChild(footer);
                            }

                            // Fade in gracefully
                            canvas.style.opacity = '1';
                        }
                    }).catch(e => {
                        console.error(e);
                        document.getElementById('pdfLoading').innerHTML = '<p style="color:#fff; font-family:sans-serif;">Erro ao carregar PDF.</p>';
                    });
                };
                document.head.appendChild(script);
                return;
            }

            // Load Font dynamically
            const fontName = restaurant.font || 'Inter';
            const link = document.createElement('link');
            link.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/ /g, '+')}:wght@400;700&display=swap`;
            link.rel = 'stylesheet';
            document.head.appendChild(link);
            document.body.style.setProperty('--font-heading', `'${fontName}', sans-serif`);
            document.body.style.fontFamily = `'${fontName}', sans-serif`;

            // Apply Custom Colors & Theme Logic
            if (restaurant.color_primary) document.documentElement.style.setProperty('--primary', restaurant.color_primary);
            if (restaurant.color_text) document.documentElement.style.setProperty('--text', restaurant.color_text);

            if (restaurant.color_background) {
                const bg = restaurant.color_background;
                document.documentElement.style.setProperty('--bg-mobile', bg);

                // Heuristic: If background is very dark, default to dark mode if no user preference set
                const isNaturallyDark = bg.toLowerCase() === '#1a1a1a' || bg.toLowerCase() === '#121212' || bg.toLowerCase() === '#000000';

                const userPref = localStorage.getItem('menu_theme');
                if (!userPref && isNaturallyDark) {
                    document.body.classList.add('dark-mode');
                    updateThemeIcon(true);
                }

                // If NOT in manual dark mode, apply the dynamic secondary colors based on background
                if (!document.body.classList.contains('dark-mode')) {
                    if (isNaturallyDark) {
                        document.documentElement.style.setProperty('--bg-card', '#252525');
                        document.documentElement.style.setProperty('--bg-badge', '#333333');
                        document.documentElement.style.setProperty('--border', '#333333');
                        document.documentElement.style.setProperty('--text-muted', '#a0a0a0');
                        document.documentElement.style.setProperty('--bg-page', '#121212');
                    } else {
                        document.documentElement.style.setProperty('--bg-card', '#FFFFFF');
                        document.documentElement.style.setProperty('--bg-badge', '#F5F7FA');
                        document.documentElement.style.setProperty('--border', '#F0F0F0');
                        document.documentElement.style.setProperty('--text-muted', '#666666');
                        document.documentElement.style.setProperty('--bg-page', '#F0F2F5');
                    }
                }
                document.getElementById('mobile-view').style.background = restaurant.color_background;
            }


            // POPULATE HEADER
            document.title = restaurant.name;
            document.getElementById('restName').textContent = restaurant.name;
            document.getElementById('restDesc').textContent = restaurant.description || '';

            // Cover
            if (restaurant.cover_url) {
                document.getElementById('coverContainer').style.backgroundImage = `url('${restaurant.cover_url}')`;
            } else {
                document.getElementById('coverContainer').style.display = 'none';
                document.getElementById('heroHeader').style.paddingTop = '100px';
            }

            // Badges
            if (restaurant.wifi_password) {
                document.getElementById('badgeWifi').style.display = 'inline-flex';
                document.getElementById('textWifi').textContent = restaurant.wifi_password;
            }
            if (restaurant.phone) {
                document.getElementById('badgePhone').style.display = 'inline-flex';
                document.getElementById('textPhone').textContent = restaurant.phone;
            }
            if (restaurant.address) {
                document.getElementById('badgeAddress').style.display = 'inline-flex';
                document.getElementById('textAddress').textContent = restaurant.address;
            }

            // LOAD ITEMS
            // LOAD ITEMS
            let { data: items } = await supabase.from('menu_items')
                .select('*')
                .eq('restaurant_id', restaurant.id)
                .order('category')
                .order('name');

            if (!items) items = [];

            // Group Items
            let uniqueCats = [...new Set(items.map(i => i.category))];

            // Apply Custom Order
            if (restaurant.category_order && Array.isArray(restaurant.category_order)) {
                const savedOrder = restaurant.category_order;
                uniqueCats.sort((a, b) => {
                    const indexA = savedOrder.indexOf(a);
                    const indexB = savedOrder.indexOf(b);
                    const valA = indexA === -1 ? 999 : indexA;
                    const valB = indexB === -1 ? 999 : indexB;
                    return valA - valB;
                });
            }

            const groups = {};
            uniqueCats.forEach(c => groups[c] = items.filter(i => i.category === c));

            // RENDER TABS & SECTIONS
            const tabsContainer = document.getElementById('categoryTabs');
            const track = document.getElementById('menuSliderTrack');
            const catImages = restaurant.category_images || {};

            uniqueCats.forEach((cat, index) => {
                // 1. Create Tab
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.textContent = cat;
                if (index === 0) btn.classList.add('active');
                btn.onclick = () => switchToCategory(index);
                tabsContainer.appendChild(btn);

                // 2. Create Section Slide
                const slide = document.createElement('div');
                slide.className = 'menu-slide';
                slide.id = `slide-${index}`;

                // Header (Banner or Title)
                let headerHTML = `<h2 class="slide-title">${cat}</h2>`;
                if (catImages[cat]) {
                    headerHTML = `
                        <div class="cat-banner">
                            <img src="${catImages[cat]}" loading="lazy">
                            <div class="cat-banner-overlay">
                                <h2>${cat}</h2>
                            </div>
                        </div>
                    `;
                }

                // Items
                let itemsHTML = groups[cat].map(item => `
                    <div class="menu-item ${!item.available ? 'unavailable' : ''}">
                        <div class="item-text">
                            <h3>${item.name}</h3>
                            <p class="item-desc">${item.description || ''}</p>
                            <div class="item-price">${item.price.toFixed(2)}€</div>
                        </div>
                        ${item.image_url ? `<div class="item-img"><img src="${item.image_url}" loading="lazy"></div>` : ''}
                    </div>
                `).join('');

                slide.innerHTML = `<div class="slide-content">${headerHTML}<div class="items-grid">${itemsHTML}</div></div>`;
                track.appendChild(slide);
            });

            let slideObserver = null;

            window.switchToCategory = (index) => {
                currentCategoryIndex = index;
                // Slide Logic
                track.style.transform = `translateX(-${index * 100}%)`;

                // Active Tab Logic
                document.querySelectorAll('.tab-btn').forEach((b, i) => {
                    if (i === index) {
                        b.classList.add('active');
                        b.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    } else {
                        b.classList.remove('active');
                    }
                });

                // --- Dynamic Height Logic ---
                const container = document.getElementById('menuSliderWindow');
                const currentSlide = track.children[index];

                if (currentSlide) {
                    // 1. Immediate set
                    container.style.height = currentSlide.offsetHeight + 'px';

                    // 2. Continuous watch (for images loading, etc)
                    if (slideObserver) slideObserver.disconnect();

                    slideObserver = new ResizeObserver(entries => {
                        for (let entry of entries) {
                            container.style.height = entry.target.offsetHeight + 'px';
                        }
                    });

                    slideObserver.observe(currentSlide);
                }
            };

            document.getElementById('loading').style.display = 'none';
            // Init height
            setTimeout(() => switchToCategory(0), 50);
        }

        init();
    </script>
</body>

</html>